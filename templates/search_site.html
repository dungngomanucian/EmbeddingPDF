<!DOCTYPE html>
<html lang="vi">
   <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>Tra cứu thông tin UTC</title>

      <link rel="stylesheet" href="{{ url_for('static', filename='propertiesOfOrigionalWebsite/css/bootstrap.min.css') }}">
      <link rel="stylesheet" href="{{ url_for('static', filename='propertiesOfOrigionalWebsite/css/style.css') }}">
      <link rel="stylesheet" href="{{ url_for('static', filename='propertiesOfOrigionalWebsite/css/responsive.css') }}">
      <link rel="icon" href="{{ url_for('static', filename='propertiesOfOrigionalWebsite/images/fevicon.png') }}" type="image/gif" />
      <link href="https://fonts.googleapis.com/css?family=Poppins:400,700|Sen:400,700,800&display=swap" rel="stylesheet">
      <link rel="stylesheet" href="{{ url_for('static', filename='propertiesOfOrigionalWebsite/css/jquery.mCustomScrollbar.min.css') }}">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
      <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap&subset=vietnamese" rel="stylesheet">
      <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

      <style>
         /* CSS CHUNG */
         .card-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #003366;
         }
         .card-header a {
            text-decoration: none;
            font-weight: 500;
            color: #343a40;
         }
         .card-header a:hover {
            text-decoration: underline;
         }
         
         /* CSS CHO MODE HÌNH ẢNH (THUMBNAIL) */
         .thumbnail-gallery {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
         }
         .thumbnail-item {
            border: 1px solid #ddd;
            padding: 5px;
            border-radius: 4px;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            width: 180px;
         }
         .thumbnail-item img {
            width: 100%;
            height: 220px;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.2s;
         }
         .thumbnail-item img:hover {
             transform: scale(1.05);
         }
         .thumbnail-item a.small-link {
            font-size: 0.8em;
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
         }

         /* CSS CHO MODE VĂN BẢN (TEXT CARD) */
         .card-text {
            text-align: justify;
            line-height: 1.7;
            white-space: pre-wrap;
         }

         /* CSS CHO MODE AI (NEW) */
         .ai-response-box {
            background: #f8fafd;
            border: 1px solid #e1e4e8;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 30px;
         }
         .ai-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #eef2f5;
            padding-bottom: 15px;
         }
         .ai-icon {
            font-size: 28px;
            color: #0d6efd;
            margin-right: 15px;
            animation: pulse 2s infinite;
         }
         .ai-title {
            font-weight: 700;
            color: #2c3e50;
            font-size: 1.3rem;
            margin: 0;
         }
         .ai-content {
            color: #212529;
            font-size: 1.05rem;
            line-height: 1.8; /* Tăng khoảng cách dòng */
            text-align: justify;
         }
         .ai-content p {
            margin-bottom: 15px;
         }
         .ai-content ul, .ai-content ol {
            margin-bottom: 20px;
            padding-left: 25px;
         }
         .ai-content li {
            margin-bottom: 8px;
         }
         .ai-content strong {
            color: #0d6efd;
            font-weight: 600;
         }
         @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
         }

         /* CSS MODAL */
         .image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.9);
            padding-top: 60px;
         }
         .image-modal-content {
            margin: auto;
            display: block;
            width: auto;
            max-width: 90%;
            max-height: 90vh;
         }
         .image-modal-close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
         }
         
         /* CSS CHO SWITCH CHẾ ĐỘ */
         .mode-switcher {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            gap: 15px;
            flex-wrap: wrap;
         }
         .mode-label {
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            padding: 8px 20px;
            border-radius: 25px;
            background-color: #fff;
            border: 1px solid #dee2e6;
            color: #495057;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
         }
         .mode-label:hover {
             background-color: #f8f9fa;
             transform: translateY(-2px);
         }
         .mode-input:checked + .mode-label {
             background-color: #003366;
             color: white;
             border-color: #003366;
             box-shadow: 0 4px 8px rgba(0,51,102,0.3);
         }
         /* Màu riêng cho nút AI */
         #mode_ai:checked + .mode-label {
             background: linear-gradient(45deg, #0d6efd, #0099ff);
             border: none;
         }
         .mode-input {
             display: none;
         }
      </style>
   </head>
   <body style="font-family: 'Montserrat', sans-serif;">
      
      <div id="imageModal" class="image-modal">
         <span class="image-modal-close" id="modalCloseBtn">&times;</span>
         <img class="image-modal-content" id="modalImage">
      </div>

      <div class="header_section">
         <div class="container">
            <nav class="navbar navbar-expand-lg navbar-light bg-light">
               <a class="navbar-brand" href="{{ url_for('home') }}">
                  <img src="{{ url_for('static', filename='propertiesOfOrigionalWebsite/images/logo.png') }}" style="height:100px; width:auto;">
               </a>
               <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent">
                  <span class="navbar-toggler-icon"></span>
               </button>
               <div class="collapse navbar-collapse" id="navbarSupportedContent">
                  <ul class="navbar-nav ml-auto">
                     <li><a href="{{ url_for('login') }}"><i class="fas fa-sign-in-alt"></i> Đăng nhập</a></li>
                     <li><a href="{{ url_for('signup') }}"><i class="fas fa-user-plus"></i> Đăng ký</a></li>
                  </ul>
               </div>
            </nav>
            <div class="custom_bg">
               <div class="custom_menu" style="width: 100%; display: flex; justify-content: center;">
                  <ul style="display: flex; list-style: none; padding: 0; margin: 0;">
                     <li><a href="{{ url_for('login') }}"><i class="fas fa-sign-in-alt"></i> Đăng nhập</a></li>
                     <li><a href="{{ url_for('signup') }}"><i class="fas fa-user-plus"></i> Đăng ký</a></li>
                  </ul>
               </div>
            </div>
         </div>
         <div class="banner_section layout_padding">
            <div class="container">
               <div class="row">
                  <div class="col-md-6">
                     <h1 class="banner_taital" style="color: #ffcf00">
                        <span style="color: #ffffff">U</span>
                        <span style="color: #a8a9ad">T</span>
                        <span style="color: #ffcf00">C</span> <br>
                        Tra cứu thông tin
                         <br> <br> <span style="color: #ffffff; font-size: 25px !important">Xin chào các bạn sinh viên!</span>
                     </h1>
                  </div>
                  <div class="col-md-6">
                     <div class="banner_img">
                        <img style="border-radius: 35px;" src="{{ url_for('static', filename='propertiesOfOrigionalWebsite/images/banner-img.png') }}">
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>
      <div class="domain_section">
         <div class="container">
            <div class="domain_box">
               <div class="domain_main">
                  
                  <!-- PHẦN CHỌN CHẾ ĐỘ TÌM KIẾM -->
                  <div class="mode-switcher">
                      <input type="radio" id="mode_ai" name="search_mode" value="ai" class="mode-input" checked>
                      <label for="mode_ai" class="mode-label"><i class="fas fa-robot"></i> Hỏi đáp AI</label>

                      <input type="radio" id="mode_image" name="search_mode" value="image" class="mode-input">
                      <label for="mode_image" class="mode-label"><i class="fas fa-image"></i> Tìm ảnh gốc</label>

                      <input type="radio" id="mode_text" name="search_mode" value="text" class="mode-input">
                      <label for="mode_text" class="mode-label"><i class="fas fa-file-alt"></i> Tìm văn bản</label>
                  </div>

                  <form id="searchForm" class="example" action="#">
                     <input type="text" id="queryInput" placeholder="Nhập câu hỏi hoặc từ khóa..." name="query" autocomplete="off">
                     <button type="submit"><i class="fas fa-search"></i> Tìm kiếm</button>
                  </form>
                  <div id="results" class="mt-4" style="padding:20px;"></div>
               </div>
            </div>
         </div>
      </div>
      <div class="about_section layout_padding">
         <!-- (Giữ nguyên footer) -->
         <div class="container">
            <div class="row">
               <div class="col-md-4">
                  <div class="about_box">
                     <div class="icon_1"><img src="{{ url_for('static', filename='propertiesOfOrigionalWebsite/images/icon-1.png') }}"></div>
                     <h3 class="faster_text">Tìm kiếm nhanh chóng</h3>
                     <p class="lorem_text">Dữ liệu cập nhật liên tục</p>
                  </div>
               </div>
               <div class="col-md-4">
                  <div class="about_box">
                     <div class="icon_1"><img src="{{ url_for('static', filename='propertiesOfOrigionalWebsite/images/icon-2.png') }}"></div>
                     <h3 class="faster_text">Thông tin chính xác</h3>
                     <p class="lorem_text">Hỗ trợ tải file thông báo gốc</p>
                  </div>
               </div>
               <div class="col-md-4">
                  <div class="about_box">
                     <div class="icon_1"><img src="{{ url_for('static', filename='propertiesOfOrigionalWebsite/images/icon-3.png') }}"></div>
                     <h3 class="faster_text">Hỗ trợ 24/7</h3>
                     <p class="lorem_text">Liên hệ phòng CTHTSV</p>
                  </div>
               </div>
            </div>
         </div>
      </div>
      <script src="{{ url_for('static', filename='propertiesOfOrigionalWebsite/js/jquery.min.js') }}"></script>
      <script src="{{ url_for('static', filename='propertiesOfOrigionalWebsite/js/popper.min.js') }}"></script>
      <script src="{{ url_for('static', filename='propertiesOfOrigionalWebsite/js/bootstrap.bundle.min.js') }}"></script>
      <script src="{{ url_for('static', filename='propertiesOfOrigionalWebsite/js/jquery-3.0.0.min.js') }}"></script>
      <script src="{{ url_for('static', filename='propertiesOfOrigionalWebsite/js/plugin.js') }}"></script>
      <script src="{{ url_for('static', filename='propertiesOfOrigionalWebsite/js/jquery.mCustomScrollbar.concat.min.js') }}"></script>
      <script src="{{ url_for('static', filename='propertiesOfOrigionalWebsite/js/custom.js') }}"></script>

      <script>
         // === JS CHO MODAL ===
         const modal = document.getElementById("imageModal");
         const modalImg = document.getElementById("modalImage");
         const closeModalBtn = document.getElementById("modalCloseBtn");

         function openModal(imgUrl) {
            modal.style.display = "block";
            modalImg.src = imgUrl;
         }
         closeModalBtn.onclick = function() { modal.style.display = "none"; }
         modal.onclick = function(event) { if (event.target === modal) modal.style.display = "none"; }

         // === LOGIC TÌM KIẾM ===
         document.getElementById("searchForm").addEventListener("submit", async (e) => {
             e.preventDefault();
             const query = document.getElementById("queryInput").value;
             const resultsDiv = document.getElementById("results");
             const searchMode = document.querySelector('input[name="search_mode"]:checked').value;

             if (!query.trim()) {
                 resultsDiv.innerHTML = "<p class='text-warning text-center'>Vui lòng nhập nội dung tìm kiếm.</p>";
                 return;
             }
             
             let loadingText = "Đang tìm kiếm thông tin...";
             if (searchMode === 'ai') {
                 loadingText = "AI đang suy nghĩ và tìm kiếm...";
             }

             resultsDiv.innerHTML = `<div class="d-flex justify-content-center"><div class="spinner-border text-primary" role="status"></div></div><p class="text-center mt-2">${loadingText}</p>`;

             try {
                 const res = await fetch(`/api/search?q=${encodeURIComponent(query)}&type=${searchMode}`);
                 const data = await res.json();
                 if (data.error) throw new Error(data.error);

                 let html = "";
                 if (data.results && data.results.length > 0) {
                     
                     // === CASE 1: CHẾ ĐỘ AI ===
                     if (searchMode === 'ai') {
                         if (data.ai_answer) {
                             html += `
                                 <div class="ai-response-box">
                                     <div class="ai-header">
                                         <i class="fas fa-sparkles ai-icon"></i>
                                         <h4 class="ai-title">Trợ lý AI trả lời:</h4>
                                     </div>
                                     <div class="ai-content">
                                         ${marked.parse(data.ai_answer)}
                                     </div>
                                 </div>
                             `;
                             
                             // Nguồn tham khảo gọn gàng
                             html += `<div class="mb-3 mt-4"><h5 class="text-muted" style="font-size:1.1rem"><i class="fas fa-book-reader"></i> Các nguồn tài liệu tham khảo:</h5></div>`;
                             data.results.forEach((r, index) => {
                                 html += `
                                     <div class="card mb-2 shadow-sm bg-light border-0">
                                         <div class="card-body py-2 d-flex align-items-center justify-content-between">
                                             <div>
                                                 <span class="badge badge-secondary mr-2">${index + 1}</span>
                                                 <span class="font-weight-bold text-dark">${r.title}</span>
                                             </div>
                                             <a href="${r.source_file_url}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                 <i class="fas fa-file-pdf"></i> Xem file gốc
                                             </a>
                                         </div>
                                     </div>`;
                             });
                         } else {
                             html = "<p class='text-center text-warning'>AI không thể tạo câu trả lời từ dữ liệu tìm thấy.</p>";
                         }
                     }
                     
                     // === CASE 2: CHẾ ĐỘ HÌNH ẢNH ===
                     else if (searchMode === 'image') {
                         html += `<h3 class='mb-4 text-center'>Kết quả Hình ảnh</h3>`;
                         const uniqueImages = new Map();
                         data.results.forEach(r => {
                             if (r.image_url && !uniqueImages.has(r.image_url)) {
                                 uniqueImages.set(r.image_url, r);
                             }
                         });
                         
                         if (uniqueImages.size > 0) {
                             html += "<div class='thumbnail-gallery'>";
                             uniqueImages.forEach(r => {
                                 html += `
                                     <div class="thumbnail-item">
                                         <img src="${r.image_url}" alt="Trang ${r.page_number}" onclick="openModal('${r.image_url}')">
                                         <p class="small text-muted mb-0"><i class="fas fa-book-open text-info"></i> <strong>Trang ${r.page_number}</strong></p>
                                         <a href="${r.source_file_url}" target="_blank" class="small-link" title="Tải file"><i class="fas fa-file-pdf"></i> ${r.source_file_pretty_name}</a>
                                     </div>`;
                             });
                             html += "</div>";
                         } else {
                             html = "<p class='text-center text-info'>Không tìm thấy hình ảnh phù hợp.</p>";
                         }
                     }

                     // === CASE 3: CHẾ ĐỘ VĂN BẢN ===
                     else {
                         html += `<h3 class='mb-4 text-center'>Kết quả Văn bản</h3>`;
                         data.results.forEach(r => {
                             html += `
                                 <div class="card mb-3 shadow-sm result-card">
                                     <div class="card-header bg-light py-2">
                                         <a href="${r.source_file_url}" target="_blank"><i class="fas fa-file-pdf"></i> <strong>Nguồn:</strong> ${r.source_file_pretty_name}</a>
                                     </div>
                                     <div class="card-body">
                                         <h5 class="card-title">${r.title}</h5>
                                         <p class="card-text">${r.content_body}</p>
                                         <p class="text-muted small mt-3 mb-0 text-right"><i class="fas fa-check-circle text-success"></i> Độ liên quan: <strong>${r.similarity ? (r.similarity * 100).toFixed(0) : 'N/A'}%</strong></p>
                                     </div>
                                 </div>`;
                         });
                     }

                 } else {
                     html = "<p class='text-center text-info'>Không tìm thấy kết quả nào phù hợp trong cơ sở dữ liệu.</p>";
                 }
                 resultsDiv.innerHTML = html;
             } catch(error) {
                 resultsDiv.innerHTML = `<p class='text-center text-danger'>Đã xảy ra lỗi khi tìm kiếm: ${error.message}</p>`;
             }
         });
      </script>
   </body>
</html>