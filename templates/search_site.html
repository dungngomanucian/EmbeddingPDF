<!DOCTYPE html>
<html lang="vi">
   <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>Tra cứu thông tin UTC</title>

      <link rel="stylesheet" href="{{ url_for('static', filename='propertiesOfOrigionalWebsite/css/bootstrap.min.css') }}">
      <link rel="stylesheet" href="{{ url_for('static', filename='propertiesOfOrigionalWebsite/css/style.css') }}">
      <link rel="stylesheet" href="{{ url_for('static', filename='propertiesOfOrigionalWebsite/css/responsive.css') }}">
      <link rel="icon" href="{{ url_for('static', filename='propertiesOfOrigionalWebsite/images/fevicon.png') }}" type="image/gif" />
      <link href="https://fonts.googleapis.com/css?family=Poppins:400,700|Sen:400,700,800&display=swap" rel="stylesheet">
      <link rel="stylesheet" href="{{ url_for('static', filename='propertiesOfOrigionalWebsite/css/jquery.mCustomScrollbar.min.css') }}">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
      <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap&subset=vietnamese" rel="stylesheet">

      <style>
         /* CSS GỐC GIỮ NGUYÊN */
         .card-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #003366;
         }
         .card-header a {
            text-decoration: none;
            font-weight: 500;
            color: #343a40;
         }
         .card-header a:hover {
            text-decoration: underline;
         }
         .highlight {
            background-color: #ffcf00;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 600;
         }
         
         /* === CSS MỚI CHO LIGHTBOX MODAL === */
         .image-modal {
            display: none; /* Ẩn mặc định */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.9);
            padding-top: 60px;
         }
         .image-modal-content {
            margin: auto;
            display: block;
            width: auto;
            max-width: 90%;
            max-height: 90vh;
         }
         .image-modal-close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
         }
         .image-modal-close:hover,
         .image-modal-close:focus {
            color: #bbb;
            text-decoration: none;
         }
         /* === KẾT THÚC CSS MỚI === */

         /* === CSS MỚI CHO ẢNH THU NHỎ === */
         .thumbnail-gallery {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
         }
         .thumbnail-item {
            border: 1px solid #ddd;
            padding: 5px;
            border-radius: 4px;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            width: 180px; /* Tăng độ rộng để chứa cả link file */
         }
         .thumbnail-item img {
            width: 100%; /* Chiều rộng 100% của parent */
            height: 220px; /* Chiều cao cố định */
            object-fit: cover; /* Giữ tỷ lệ, cắt bớt nếu cần */
            cursor: pointer;
            transition: transform 0.2s;
         }
         .thumbnail-item img:hover {
             transform: scale(1.05);
         }
         .thumbnail-item p {
             margin: 5px 0 0 0;
         }
         .thumbnail-item a.small-link {
            font-size: 0.8em;
            display: block; /* Cho link xuống dòng */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* Cắt ngắn link nếu quá dài */
         }
         /* === KẾT THÚC CSS MỚI === */
         
      </style>
   </head>
   <body style="font-family: 'Montserrat', sans-serif;">
      
      <div id="imageModal" class="image-modal">
         <span class="image-modal-close" id="modalCloseBtn">&times;</span>
         <img class="image-modal-content" id="modalImage">
      </div>
      <div class="header_section">
         <div class="container">
            <nav class="navbar navbar-expand-lg navbar-light bg-light">
               <a class="navbar-brand" href="{{ url_for('home') }}">
                  <img src="{{ url_for('static', filename='propertiesOfOrigionalWebsite/images/logo.png') }}" style="height:100px; width:auto;">
               </a>
               <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent">
                  <span class="navbar-toggler-icon"></span>
               </button>
               <div class="collapse navbar-collapse" id="navbarSupportedContent">
                  <ul class="navbar-nav ml-auto">
                     <li><a href="{{ url_for('login') }}"><i class="fas fa-sign-in-alt"></i> Đăng nhập</a></li>
                     <li><a href="{{ url_for('signup') }}"><i class="fas fa-user-plus"></i> Đăng ký</a></li>
                  </ul>
               </div>
            </nav>
            <div class="custom_bg">
               <div class="custom_menu" style="width: 100%; display: flex; justify-content: center;">
                  <ul style="display: flex; list-style: none; padding: 0; margin: 0;">
                     <li><a href="{{ url_for('login') }}"><i class="fas fa-sign-in-alt"></i> Đăng nhập</a></li>
                     <li><a href="{{ url_for('signup') }}"><i class="fas fa-user-plus"></i> Đăng ký</a></li>
                  </ul>
               </div>
            </div>
         </div>
         <div class="banner_section layout_padding">
            <div class="container">
               <div class="row">
                  <div class="col-md-6">
                     <h1 class="banner_taital" style="color: #ffcf00">
                        <span style="color: #ffffff">U</span>
                        <span style="color: #a8a9ad">T</span>
                        <span style="color: #ffcf00">C</span> <br>
                        Tra cứu thông tin
                         <br> <br> <span style="color: #ffffff; font-size: 25px !important">Xin chào các bạn sinh viên!</span>
                     </h1>
                  </div>
                  <div class="col-md-6">
                     <div class="banner_img">
                        <img style="border-radius: 35px;" src="{{ url_for('static', filename='propertiesOfOrigionalWebsite/images/banner-img.png') }}">
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>
      <div class="domain_section">
         <div class="container">
            <div class="domain_box">
               <div class="domain_main">
                  <form id="searchForm" class="example" action="#">
                     <input type="text" id="queryInput" placeholder="Nhập câu hỏi hoặc từ khóa..." name="query" autocomplete="off">
                     <button type="submit"><i class="fas fa-search"></i> Tìm kiếm</button>
                  </form>
                  <div id="results" class="mt-4" style="padding:20px;"></div>
               </div>
            </div>
         </div>
      </div>
      <div class="about_section layout_padding">
         <div class="container">
            <div class="row">
               <div class="col-md-4">
                  <div class="about_box">
                     <div class="icon_1"><img src="{{ url_for('static', filename='propertiesOfOrigionalWebsite/images/icon-1.png') }}"></div>
                     <h3 class="faster_text">Tìm kiếm nhanh chóng</h3>
                     <p class="lorem_text">Dữ liệu cập nhật liên tục</p>
                  </div>
               </div>
               <div class="col-md-4">
                  <div class="about_box">
                     <div class="icon_1"><img src="{{ url_for('static', filename='propertiesOfOrigionalWebsite/images/icon-2.png') }}"></div>
                     <h3 class="faster_text">Thông tin chính xác</h3>
                     <p class="lorem_text">Hỗ trợ tải file thông báo gốc</p>
                  </div>
               </div>
               <div class="col-md-4">
                  <div class="about_box">
                     <div class="icon_1"><img src="{{ url_for('static', filename='propertiesOfOrigionalWebsite/images/icon-3.png') }}"></div>
                     <h3 class="faster_text">Hỗ trợ 24/7</h3>
                     <p class="lorem_text">Liên hệ phòng CTHTSV</p>
                  </div>
               </div>
            </div>
         </div>
      </div>
      <script src="{{ url_for('static', filename='propertiesOfOrigionalWebsite/js/jquery.min.js') }}"></script>
      <script src="{{ url_for('static', filename='propertiesOfOrigionalWebsite/js/popper.min.js') }}"></script>
      <script src="{{ url_for('static', filename='propertiesOfOrigionalWebsite/js/bootstrap.bundle.min.js') }}"></script>
      <script src="{{ url_for('static', filename='propertiesOfOrigionalWebsite/js/jquery-3.0.0.min.js') }}"></script>
      <script src="{{ url_for('static', filename='propertiesOfOrigionalWebsite/js/plugin.js') }}"></script>
      <script src="{{ url_for('static', filename='propertiesOfOrigionalWebsite/js/jquery.mCustomScrollbar.concat.min.js') }}"></script>
      <script src="{{ url_for('static', filename='propertiesOfOrigionalWebsite/js/custom.js') }}"></script>

      <script>
         // === JS MỚI CHO MODAL ===
         const modal = document.getElementById("imageModal");
         const modalImg = document.getElementById("modalImage");
         const closeModalBtn = document.getElementById("modalCloseBtn");

         // Hàm mở modal
         function openModal(imgUrl) {
            modal.style.display = "block";
            modalImg.src = imgUrl;
         }

         // Hàm đóng modal
         closeModalBtn.onclick = function() {
            modal.style.display = "none";
         }
         modal.onclick = function(event) {
             // Nếu click vào nền đen (không phải ảnh) thì đóng modal
             if (event.target === modal) {
                 modal.style.display = "none";
             }
         }
         // === KẾT THÚC JS MỚI ===


         document.getElementById("searchForm").addEventListener("submit", async (e) => {
             e.preventDefault();
             const query = document.getElementById("queryInput").value;
             const resultsDiv = document.getElementById("results");

             if (!query.trim()) {
                 resultsDiv.innerHTML = "<p class='text-warning text-center'>Vui lòng nhập nội dung tìm kiếm.</p>";
                 return;
             }
             
             // Hàm highlight không còn cần thiết vì không hiển thị text
             // const highlightKeywords = ...

             resultsDiv.innerHTML = `<div class="d-flex justify-content-center"><div class="spinner-border text-primary" role="status"></div></div><p class="text-center mt-2">Đang tìm kiếm...</p>`;

             try {
                 const res = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
                 const data = await res.json();
                 if (data.error) throw new Error(data.error);

                 let html = "";
                 if (data.results && data.results.length > 0) {
                     
                     // === LOGIC LỌC ẢNH TRÙNG LẶP ===
                     const uniqueImages = new Map();
                     data.results.forEach(r => {
                         // Chỉ thêm nếu ảnh có URL và chưa tồn tại
                         if (r.image_url && !uniqueImages.has(r.image_url)) {
                             uniqueImages.set(r.image_url, r);
                         }
                     });
                     // === KẾT THÚC LOGIC LỌC ===
                     
                     if (uniqueImages.size > 0) {
                         html += "<h3 class='mb-4 text-center'>Các trang liên quan</h3>";
                         html += "<div class='thumbnail-gallery'>"; // Bắt đầu flex container

                         // Lặp qua các ảnh đã lọc
                         uniqueImages.forEach(r => {
                             // === ĐÂY LÀ KHỐI HTML MỚI ===
                             // Không dùng card, chỉ dùng thumbnail
                             html += `
                                 <div class="thumbnail-item">
                                     <img src="${r.image_url}" 
                                          alt="Trang ${r.page_number}"
                                          onclick="openModal('${r.image_url}')">
                                     <p class="small text-muted mb-0">
                                         <i class="fas fa-book-open text-info"></i>
                                         <strong>Trang ${r.page_number}</strong>
                                     </p>
                                     <a href="${r.source_file_url}" target="_blank" class="small-link" title="Tải file ${r.source_file_pretty_name}">
                                         <i class="fas fa-file-pdf"></i>
                                         ${r.source_file_pretty_name}
                                     </a>
                                 </div>
                             `;
                             // === KẾT THÚC KHỐI HTML MỚI ===
                         });

                         html += "</div>"; // Kết thúc flex container
                     } else {
                         html = "<p class='text-center text-info'>Không tìm thấy kết quả nào phù hợp.</p>";
                     }

                 } else {
                     html = "<p class='text-center text-info'>Không tìm thấy kết quả nào phù hợp.</p>";
                 }
                 resultsDiv.innerHTML = html;
             } catch(error) {
                 resultsDiv.innerHTML = `<p class='text-center text-danger'>Đã xảy ra lỗi khi tìm kiếm: ${error.message}</p>`;
             }
         });
      </script>
      </body>
</html>